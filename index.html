<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Strvct</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.2/marked.min.js"></script>
<link href="resources/fonts/ShareTechMono/font.css" rel="stylesheet" type="text/css">
<link href="resources/fonts/Blender Pro/font.css" rel="stylesheet" type="text/css">
<link href="resources/fonts/BarlowCondensed/font.css" rel="stylesheet" type="text/css">
<style>
body {
 font-family: "Helvetica", Helvetica, Arial, sans-serif;
 font-weight: 300;
 line-height: 1.6;
 font-size: 16px;
 background-color: #191919;
 color: #aaa;
 max-width: 800px;
 margin-top: max(3em, 10%);
 margin-left: max(1em, 10%);
 margin-right: max(3em, 10%);
 margin-bottom: max(3em, 10%);

 padding: 0;
 box-sizing: content-box;
}
hr {
  width: 100%;
}
h1, h2, h3, h4, h5 {
 color: #f4f4ec;
}
h1 {
 margin-top: 0em;
 font-size: 3em;
 font-family: "Blender Pro", "Helvetica", sans-serif;
 text-transform: uppercase;
}
h2 {
 margin-top: 2.5em;
 opacity: 0.8;
 font-size: 1.5em;
 font-weight: 300;
}
h3, h4, h5 {
 margin-top: 1.5em;
 opacity: 0.9;
 font-size: 1.1em;
 font-weight: 300;
}
h4 {
 font-size: 1em;
}
hr {
 margin-top: 2em;
 margin-bottom: 2em;
 opacity: 0.2;
}
code {
 border-radius: 0.5em;
 font-family: "Helvetica", "Blender Pro", monospace;
 opacity: 0.7;
}
pre {
 background-color: rgba(255, 255, 255, 0.1);
 padding: 0.5em;
 padding-left: 1em;
 border-radius: 4px;
 overflow-x: auto;
 white-space: pre-wrap;
}
blockquote {
 border-left: 4px solid #ccc;
 margin-left: 0;
 font-style: italic;
}
a:link, a:visited {
 font-family: "Helvetica", sans-serif;
 color: #999;
 text-decoration: none;
 transition: background-color .15s linear, color .15s linear;
}
a:hover {
 color: #fff;
 text-shadow: 0px 0px 1px white;
 transition: .2s text-shadow;
}
/* New style for reference list */
.reference-list {
  margin-top: 2em;
  border-top: 1px solid #444;
  padding-top: 1em;
}
.reference-item {
  margin-bottom: 0.5em;
}
diagram {
  display: flex;  
  justify-content: center;
  flex-wrap: wrap;
  gap: 0.5em; 
  padding: 1em;
  border: 0px solid #333;
  overflow: hidden;
  height: fit-content;
  width: 100%;
  text-align: center;
}

object {
  display: flex;
  border: 0px none red;
  height: auto;
  width: fit-content;
  max-width: 100%;
  max-height: 100%;
  margin: 0em;
  padding: 0em;
}

</style>
</head>
<body>
<div id="content">Loading...</div>
<script>
async function loadAndRenderMarkdown() {
  try {
    const response = await fetch('README.md');
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    const markdown = await response.text();

    const referenceMap = new Map();
    const referenceList = [];
    const toc = [];

    // Extract title from markdown
    const titleMatch = markdown.match(/<head>\s*<title>([^<]+)<\/title>\s*<\/head>/);
    if (titleMatch) {
      document.title = titleMatch[1].trim();
    }

    // Remove the title section from the markdown
    const contentWithoutTitle = markdown.replace(/<head>[\s\S]*?<\/head>/, '');

    // First pass: extract references
    const lines = contentWithoutTitle.split('\n');
    const contentLines = lines.filter(line => {
      const match = line.match(/^\[(.+)\]:\s*(.+?)\s*(?:"(.+)")?$/);
      if (match) {
        const [, key, url, title] = match;
        referenceMap.set(key, { url, title: title || '' });
        referenceList.push({ key, url, title });
        return false;
      }
      return true;
    });

    // Custom renderer
    const renderer = new marked.Renderer();

    // Override heading renderer to add IDs and collect TOC items
    renderer.heading = function(text, level) {
      const slug = text.toLowerCase().replace(/[^\w]+/g, '-');
      toc.push({ text, level, slug });
      return `<h${level} id="${slug}">${text}</h${level}>`;
    };

    // Override the paragraph renderer to add links to citations
    renderer.paragraph = function(text) {
      const citationRegex = /\[(\d+)\]/g;
      const linkedText = text.replace(citationRegex, (match, p1) => {
        if (referenceMap.has(p1)) {
          return `<a href="#ref-${p1}" style="text-decoration: none;">${match}</a>`;
        }
        return match;
      });
      return `<p>${linkedText}</p>`;
    };

    marked.use({ renderer });

    // Generate table of contents
    function generateTOC(items) {
      let currentLevel = 1;
      let html = '<ul>';
      items.forEach(item => {
        if (item.level > currentLevel) {
          html += '<ul>'.repeat(item.level - currentLevel);
        } else if (item.level < currentLevel) {
          html += '</ul>'.repeat(currentLevel - item.level);
        }
        html += `<li><a href="#${item.slug}">${item.text}</a></li>`;
        currentLevel = item.level;
      });
      html += '</ul>'.repeat(currentLevel);
      return html;
    }

    // Function to decode URL-encoded strings
    function decodeURL(url) {
      try {
        return decodeURIComponent(url.replace(/\+/g, ' '));
      } catch (e) {
        return url; // Return original URL if decoding fails
      }
    }

    // Replace [TOC] with a unique HTML comment placeholder
    const tocPlaceholder = '<!--TOC_PLACEHOLDER-->';
    const contentWithPlaceholder = contentLines.join('\n').replace('[TOC]', tocPlaceholder);

    // Parse the content
    let content = marked.parse(contentWithPlaceholder);

    // Generate table of contents
    const tocHtml = generateTOC(toc);

    // Replace the placeholder with the table of contents
    content = content.replace(tocPlaceholder, `<table-of-contents>\n${tocHtml}\n</table-of-contents>`);

    // Add references section
    const referencesSection = referenceList.length > 0
      ? `<div class="reference-list">
           <h2>References</h2>
           ${referenceList.map(({ key, url, title }) => `
             <div class="reference-item" id="ref-${key}">
               ${key}. ${title ? `${title}` : ''}
               <br>
               <a href="${url}" target="_blank">${decodeURL(url)}</a>
             </div>`).join('')}
         </div>`
      : '';

    document.getElementById('content').innerHTML = `
      ${content}
      ${referencesSection}
    `;
  } catch (error) {
    console.error('Error loading Markdown:', error);
    document.getElementById('content').innerHTML = 'Error loading content. Please check the console for details.';
  }
}

window.onload = loadAndRenderMarkdown;
</script>
</body>
</html>